function [Y,Xf,Af] = myNeuralNetworkFunction3(X,~,~)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 03-May-2017 17:51:59.
%
% [Y] = myNeuralNetworkFunction(X,~,~) takes these arguments:
%
%   X = 1xTS cell, 1 inputs over TS timsteps
%   Each X{1,ts} = 96xQ matrix, input #1 at timestep ts.
%
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 3xQ matrix, output #1 at timestep ts.
%
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1_remove = [13 17 19 23 26 29 31 34 37 38 39 41 43 46 47 51 52 53 57 58 59 61 62 65 67 68 69 71 73 74 75 76 78 79 81 82 83 85 86 87 89 90 91 92 93 94 95];
x1_step1_keep = [1 2 3 4 5 6 7 8 9 10 11 12 14 15 16 18 20 21 22 24 25 27 28 30 32 33 35 36 40 42 44 45 48 49 50 54 55 56 60 63 64 66 70 72 77 80 84 88 96];
x1_step2_xoffset = [0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0];
x1_step2_gain = [2;0.2;0.0909090909090909;0.117647058823529;0.111111111111111;0.111111111111111;0.0952380952380952;0.133333333333333;0.142857142857143;0.08;0.117647058823529;0.0714285714285714;0.08;0.0740740740740741;0.0909090909090909;0.0666666666666667;0.0869565217391304;0.08;0.125;0.0952380952380952;0.0666666666666667;0.142857142857143;0.0769230769230769;0.0689655172413793;0.0952380952380952;0.08;0.0714285714285714;0.0952380952380952;0.142857142857143;0.105263157894737;0.0555555555555556;0.0952380952380952;0.153846153846154;0.125;0.0833333333333333;0.0952380952380952;0.08;0.25;0.0769230769230769;0.0952380952380952;0.166666666666667;0.0833333333333333;0.117647058823529;0.166666666666667;0.133333333333333;0.166666666666667;0.111111111111111;0.2;0.153846153846154];
x1_step2_ymin = -1;

% Layer 1
b1 = [1.6789344804309851;-0.80817653255090272;0.93128607105789296;-0.5398463187896525;0.34177956638951118;-0.1112758577694771;-0.54008250643019995;-0.80871586443549093;-1.2185660996346739;-1.4596769306177357];
IW1_1 = [-0.32546435392624196 -0.042691013333621408 -0.56441934611925693 -0.70954845317071757 -0.64404749681249707 -0.59912889832103222 -0.81777313408712882 0.4520949468739211 -0.015899452675533197 -0.26668604018406905 0.16560396077306991 0.47486326014749691 0.40236224259455899 0.41544227939646422 0.52809534333531449 0.23703019052453059 0.16115416272930605 0.71655140896477942 0.55216304956335183 0.45258783112129564 0.4255776022474449 0.0043054341062850887 0.42564336269886355 0.0050876479933041133 0.027804590912580158 -0.24002428245870952 -0.10452188315631333 -0.17494051670716401 -0.86156503985183508 -0.25004816584583167 -0.065673567183411066 -0.27791570374553543 -0.88601315904478806 -0.073389025761920842 0.27847512006113351 0.42884176672472207 0.13791717447845439 -0.43440216817736055 0.1713562863513215 0.35895273934172317 0.17799858226832585 0.46478438376510506 -0.02163135353957164 0.057225005468090499 0.054996700709767754 -0.13128062813160157 0.33944398978956886 0.25214467251814399 -0.25161551256222858;-0.28044655770394467 -0.14210849442318255 -0.32657879459455297 -1.066514422410288 -0.78296862572177361 -0.33354334817736009 -0.6343940579779036 -0.23950128424867134 0.04807762766106697 0.17208719141103512 0.46209326183146288 0.28188881701421997 0.037542194587292348 0.41546922537913888 0.010532350483661735 0.58963184561057069 -0.19585700572458126 0.32017185366605905 0.25101600617500247 0.58259405089750205 0.23280221502237222 -0.50631583546531289 0.034204858044687723 0.013742775319272699 0.49578301934640912 -0.35282810191855096 0.18926122844515628 -0.39088591107344622 -0.91591124014411351 -0.42458818058363901 0.24737888315027867 -0.42739859837890209 -0.62569777714357777 0.32904402772049346 0.31010166500662117 0.28726793826445907 0.052231436246675443 -0.48309663542793807 0.32373182621657998 -0.11350812568101187 0.027690180269560199 0.45316207793254404 0.50525576578546572 -0.11031332519915915 -0.24277227629748063 -0.22795903884844793 -0.23011229577936387 -0.0871031925676133 -0.3261005769696349;-0.4579531954743794 -0.41511918272901432 0.16699398451541256 -0.10905582133021824 0.30901602837431258 0.07965478248180384 0.28588937152506361 -0.16546131032187217 -0.25679211494138277 0.14445070253253256 0.1832429592375393 -0.1255733035406599 0.17312462007035112 -0.13761417909140652 -0.021017176169958934 -0.079845629871813525 -0.34958592170473418 0.021790602373739483 0.12375463626650214 0.31519592581399919 -0.057906054147687382 -0.04524067679590861 -0.11799682986641684 -0.21745250517495149 0.12502837243843903 0.10646616795452427 -0.12824251539034245 -0.41381110410185984 -0.27899331236275937 -0.16002090149533335 0.075730240931560319 0.023495990924767989 -0.4665974603450187 -0.28042377252996298 -0.25971070093178594 -0.067747026364989998 -0.23311890057356099 -0.26948373903099465 -0.17188812102833653 0.28349497235784094 -0.14468473969539958 0.10568230632740169 0.11211912089885312 0.14255955480725346 -0.14818943600885143 -0.2977094933618713 0.079014044170572797 -0.29040731704303729 -0.18732197552079405;0.054644365155338714 -0.023595543724604047 -0.25436823701296302 -0.55077706268679527 -0.73176353095167435 -0.62759996225142756 -0.47652841582431688 -0.1707231189725722 0.064423323797603363 0.52466092207996762 0.092502195758153091 0.49129835348674555 0.039960021132555465 0.17289591602783599 0.066076386875338969 0.41676052558929411 0.17762646718759148 0.3530162356457367 0.72266465120837775 0.71871945923154079 0.8071139237888354 -0.194707601556905 0.40299186348626448 -0.34202946540748769 0.53181690807616966 0.37949654884169914 -0.24470379647021182 -0.053082443664957117 -0.72552951730762516 -0.13054004177828804 0.58141288294981586 -0.12611002408935401 -0.3259098897559356 0.062176314021658276 0.3219186237256435 -0.57440146211162679 -0.048735094284116751 -0.25902086109695216 -0.043712247892864362 -0.35321685382915147 -0.25615625706818257 -0.10066123846993309 0.22026537587823525 -0.29502807929588465 -0.21916775684034334 -0.1900141998642095 0.20036477942308983 0.37142481662765631 -0.12883238910803152;-0.30612424419511969 -0.2121268064415347 -0.70648993617892886 -0.084900975876987514 -0.14969563719385828 -0.166465627411225 -0.12866835480886935 0.65828146702765566 0.13326820968072006 -0.2252970899318982 0.0036049453418634694 0.18780934475820449 0.59818675266687382 -0.43277116381509545 0.55037125723076774 -0.10464302882136989 -0.35211434762799604 0.53371725448380647 -0.77016349761337788 0.074361937225195851 -0.34731951751820539 0.049449088584198775 0.22663413110551114 0.56942627237863264 0.15381561289728976 -0.37711033279928308 -0.18815361926692667 -0.072499467132048745 -0.1868998124317309 -0.027129485196908745 -0.66442506005238422 -0.25498738390394526 -0.44348499690393656 0.12689899203395569 0.16015251580866882 0.63391852170148233 0.55619286191142536 -0.39108164276753599 0.26169951333614239 0.040665486578493074 0.44209059220624336 0.50418095223600734 0.25366704003757728 -0.37927029024872283 0.044392819164598911 0.12697398849866523 -0.0038411282647521213 -0.011226673311731416 0.35593648820194446;-0.27529118087369914 0.30424718510613036 0.5448559747177133 0.014708472701515115 0.13784854890529979 0.050199694264242638 -0.20026892084698097 -0.16420077295906632 0.24476388467227661 -0.16276659711749467 -0.29017906738831883 -0.47343413312931099 -0.6812503323935396 -0.045769990717467471 -0.058345639347770248 -0.48655756408828688 0.037701483599651725 -0.092849567706840053 -0.22396284324881224 0.0049069621730827608 0.22844572268786445 -0.25911691620903737 -0.67564620403796016 -0.0059311523417826424 -0.10268548858761577 -0.21563470636682883 -0.31744730752986938 0.41147510798908954 0.13086603259688709 0.38698881802246665 0.03348840361493903 -0.1111105406282334 -0.12837924084864219 -0.079231967745238566 -0.19824265443783426 -0.63245080171438872 -0.11435288669555661 -0.27860116889293879 -0.36848047017065816 -0.3992414609685026 0.047691993867246631 -0.30300982884138128 -0.0087995662704275172 -0.10403529959892968 -0.14418226787940835 -0.082406062449664363 -0.16832763285792671 -0.14145761527914974 -0.41542171251145926;-0.1547826401486711 0.19549607614360906 0.35325995836768609 -0.56918202315787081 -0.47769437513834839 -0.4001530094778919 -0.19988160826644336 -0.10153207416453837 -0.12437616064158973 0.4749087063139219 0.3809887520663896 0.32278072809661912 -0.61086053433748233 0.020254862211198224 -0.21506135462837606 0.086135699167996516 0.20539856736305903 -0.39056819662279785 0.6476651475676366 0.38982281112504918 0.57600899616462742 0.019101054401561828 -0.039307659545850596 -0.179848941969176 0.15340983528825486 0.10377952653394833 0.17752676032490566 0.045042283709000319 -0.098925933735064239 0.044079999494692955 0.10202410868324524 0.042215876108159855 -0.068599443756940395 -0.24599662974573674 0.15004644856543836 -0.93838905263385053 -0.1675561485893611 0.16356559486079991 -0.27146093792574416 -0.14656221139415695 -0.30716788802629447 -0.11705158778205724 -0.31715432186233306 0.15296419283882012 0.25873750275676649 0.11215710029515634 0.050782617486207063 0.12331731062456916 -0.29974605076090555;-0.030722494819167914 -0.21716888092052453 0.51184572645995174 0.56585560276370039 0.5270315775907809 0.4518051016620433 0.22806678585612164 -0.0636309137595647 -0.096881965699096254 0.11531783083303265 -0.047108300367143696 -0.31328576021219345 -0.038420309752871133 -0.49334707900675484 -0.079822887065966255 -0.12668980835300248 -0.56581059648490872 0.11562179149803484 -0.5625569316927177 0.14441415001480276 -0.40229538244231838 -0.35070619179781853 -0.52049591913647109 0.34242186718235107 -0.50850046519811276 -0.45290786378428116 -0.059321372963491936 0.33141617946839058 0.37073516507857768 0.34560213938322748 -0.64192895718974663 -0.15967279115572186 -0.11588516573227722 0.13761698312748882 -0.58708225880876719 0.066375139296507193 -0.43403533186379606 0.12957028905645049 -0.1848764619368409 -0.14415148913553111 -0.0022665696286173669 0.35248679715743481 0.25287038975025311 -0.16607588772849716 -0.27143933572116108 -0.016417351625181278 0.079945552423759378 -0.29718699455121472 0.22218928303241128;0.046849539269722379 0.0055274488203201641 0.17371827283442282 0.038142225328489335 -0.060450548389249084 0.22256092818142095 -0.032072307508538414 0.09681699838188261 0.20601783354931735 0.28798675785077493 0.30843974142436553 0.21315363206337398 0.20736570583471692 0.22189698412756689 -0.26221021290583535 -0.019931581876157265 0.22789966665090231 -0.2601033013412728 -0.21615383374169844 -0.23507213521719073 -0.16025138849939943 -0.048527299434436101 0.18773868317053055 -0.12449134601439733 -0.21570488999186516 -0.075617112299392011 0.33234858867404021 0.029700260976649757 -0.10659010672966142 -0.26076652729002048 0.22283874503272588 -0.1745169980640284 0.14521878125327667 0.35941508591985882 -0.090957480500810053 -0.34354811819016895 -0.023663850518652232 0.42077772022999949 0.24601533072379589 0.37250885795554711 0.0089198439606553801 0.33324131818330271 -0.21855476409001748 0.085447587818402768 0.26393027619890752 0.25136183382240895 0.2391821474296221 -0.084915662010961734 0.28430376387751582;-0.12993955192235065 -0.043235608383581071 0.09100407813019637 -0.09041742430035199 0.18767999945375666 0.016329558693917532 0.30100566635892989 -0.15109056056243483 0.32715518276032279 0.18797584657959632 0.33371754995852387 -0.22556511349846933 0.19994704847755085 -0.034976640590758494 0.11880025275494259 0.25175674141450988 -0.24171201399119999 -0.064330075364106509 0.034685103182562523 -0.29879487650315767 -0.3265733500800494 0.30248376023388174 0.26722288214216106 0.11165781267172491 0.22333822198422859 0.32711370038574838 -0.07747844048736402 0.2168202857697093 0.30704516030654611 -0.056010621629726823 -0.28934072634266844 0.099320527479030724 -0.22847376758160887 0.24765448639218954 -0.19849200170691669 0.25226580211397348 0.19437505651888717 0.25474074356568116 0.27219168900012197 -0.26343440211399027 0.16953355039837231 -0.053394901486624916 -0.29777979902311269 0.047511062711427063 0.25427178944465639 -0.029092500795920184 0.066310067796009828 0.2101639907957874 0.0307337184755983];

% Layer 2
b2 = [-0.53117085783160689;-0.12835280389000309;0.17662223571260779];
LW2_1 = [1.584086786380607 2.3529187517029451 1.1822831445657669 2.7421957910776191 -0.71427259238040874 -0.10262669228387017 2.4053936529771844 -1.8615388589598241 -1.0179865327780018 -0.079260579017579214;3.1555664861573938 0.81236895287265665 0.72637017390960645 -1.237987953006531 3.6403019211954954 -0.29857458916626278 -2.9552566347374545 0.23885580895185402 -0.67123843664057703 -0.021974685466890166;-2.842633621081704 -1.8660364747954095 -0.40772110633607267 -1.9683526949532464 -1.9837815088633288 0.044492194965099603 -0.080518145432670093 1.2140506950594074 0.17586037661515491 -0.5517811622459976];

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX, X = {X}; end;

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
    Q = size(X{1},2); % samples/series
else
    Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS
    
    % Input 1
    temp = removeconstantrows_apply(X{1,ts},x1_step1_keep,x1_step1_remove);
    Xp1 = mapminmax_apply(temp,x1_step2_gain,x1_step2_xoffset,x1_step2_ymin);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = softmax_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Output 1
    Y{1,ts} = a2;
end

% Final Delay States
Xf = cell(1,0);
Af = cell(2,0);

% Format Output Arguments
if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings_gain,settings_xoffset,settings_ymin)
y = bsxfun(@minus,x,settings_xoffset);
y = bsxfun(@times,y,settings_gain);
y = bsxfun(@plus,y,settings_ymin);
end

% Remove Constants Input Processing Function
function y = removeconstantrows_apply(x,settings_keep,settings_remove)
if isempty(settings_remove)
    y = x;
else
    y = x(settings_keep,:);
end
end

% Competitive Soft Transfer Function
function a = softmax_apply(n)
nmax = max(n,[],1);
n = bsxfun(@minus,n,nmax);
numer = exp(n);
denom = sum(numer,1);
denom(denom == 0) = 1;
a = bsxfun(@rdivide,numer,denom);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n)
a = 2 ./ (1 + exp(-2*n)) - 1;
end
